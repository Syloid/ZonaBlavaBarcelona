<html>

<head>
    <title>ZonaBlavaBarcelona</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.0/css/all.css"
        integrity="sha384-Mmxa0mLqhmOeaE8vgOSbKacftZcsNYDjQzuCOm6D02luYSzBG8vpaOykv9lFQ51Y" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <link rel="stylesheet" href="css/style.css">

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">ZonaBlavaBarcelona</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#grafiques">Estadistiques</a>
                </li>
            </ul>
        </div>
    </nav>

    <div id="contingut"></div>
    <div id='mapContainer'></div>
    <div id='grafiques'>

        <table class="columns">
            <tr>
                <td>
                    <div id="donutchart" style='width: 45vw'>
                </td>
                <td>
                    <div id="barChart" style='width: 45vw'></div>
                </td>
            </tr>
        </table>
        <br />
        <div id="piechart_3d"></div>
    </div>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
        integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            posicioUsuari =[];
            getLocation();
            inicialitzar(3);
        });

        function inicialitzar(frequencia) {
            
            var frequenciaActualitzacio = frequencia; //inicialitzem
            interval = setInterval(consultaDades, frequenciaActualitzacio * 1000); //actualitzem dades cada quan toqui....
            $("#interval").html(parseInt(frequenciaActualitzacio));
        }

        var lastUpdateTime = 0;

        function consultaDades() {
            $.ajax({
                url: 'https://opendata-ajuntament.barcelona.cat/resources/bsm/PSIU_AREABLAVA.JSON'
            }).done(function (data) {
                if (data.OPENDATA_PSIU_APPARKB[0].FH_INICIO != lastUpdateTime) {
                    lastUpdateTime = data.OPENDATA_PSIU_APPARKB[0].FH_INICIO;
                    date = new Date(parseInt(lastUpdateTime.substring(6, 10)), parseInt(lastUpdateTime.substring(3, 5)) - 1, parseInt(lastUpdateTime.substring(0, 2)), 8, 0, 0);
                    resetDate = date;
                    actualitzaDadesPantalla(data);
                }
            })
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(guardarPosicio);
            } else { 
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function guardarPosicio(position) {
            //assignem les coordenades d'on es troba l'posicioUsuari
            posicioUsuari['latitude'] = position.coords.latitude; 
            posicioUsuari['longitude'] = position.coords.longitude;
        }

        function actualitzaDadesPantalla(data) {

            var aparcaments = data.OPENDATA_PSIU_APPARKB[1].TRAMOS[0].features;

            var TIPUS_ZONA = []; //Blava o verda
            var TIPUS_TARIFA = []; //Tots els tipus de tarifa
            var TIPUS_HORARI = []; // Tots els horaris

            for (i = 0; i < aparcaments.length; i++) {
                isNaN(TIPUS_ZONA[aparcaments[i].properties.TIPO]) ? TIPUS_ZONA[aparcaments[i].properties.TIPO] = 0 : TIPUS_ZONA[aparcaments[i].properties.TIPO]++;
                isNaN(TIPUS_TARIFA[aparcaments[i].properties.TARIFA]) ? TIPUS_TARIFA[aparcaments[i].properties.TARIFA] = 0 : TIPUS_TARIFA[aparcaments[i].properties.TARIFA]++;
                isNaN(TIPUS_HORARI[aparcaments[i].properties.HORARIO]) ? TIPUS_HORARI[aparcaments[i].properties.HORARIO] = 0 : TIPUS_HORARI[aparcaments[i].properties.HORARIO]++;
            }
            console.log(TIPUS_HORARI);

            map(aparcaments);
            $('#grafiques').prepend('<h1>Estadistiques</h1>');
            donutChart(TIPUS_ZONA);
            barChart(TIPUS_TARIFA);
            piechart3D(TIPUS_HORARI);
        }

        function convertirDadesPerChart(info, tipus) {
            var datos = new Array(tipus);
            for (tipo in info) {
                var tipoinfo = new Array(tipo);
                tipoinfo.push(info[tipo]);
                datos.push(tipoinfo);
            }

            return datos;
        }

        function piechart3D(info) {
            google.charts.load("current", { packages: ["corechart"] });
            google.charts.setOnLoadCallback(drawChart);
            function drawChart() {
                var datos = convertirDadesPerChart(info, ['Horari', 'Quantitat',]);
                var data = google.visualization.arrayToDataTable(datos);

                var options = {
                    title: 'Quantitat d\'aparcaments segons horari ',
                    pieHole: 0.4,
                    backgroundColor: '#3b4147',
                    pieSliceBorderColor: '#343a40',
                    pieSliceTextStyle: {
                        color: 'white'
                    },
                    legend: {
                        position: 'bottom',
                        textStyle: {
                            color: 'white'
                        }
                    },
                    titleTextStyle: {
                        color: 'white'
                    },
                    is3D: true
                };

                var chart = new google.visualization.PieChart(document.getElementById('piechart_3d'));
                chart.draw(data, options);
            }
        }

        function barChart(info) {
            var datos = convertirDadesPerChart(info, ['Tarifa', 'Quantitat',]);
            google.charts.load('current', { packages: ['corechart', 'bar'] });
            google.charts.setOnLoadCallback(drawBasic);

            function drawBasic() {

                var data = google.visualization.arrayToDataTable(datos);
                data.sort([{ column: 1, desc: true }, { column: 0, desc: true }]);

                var options = {
                    title: 'Preu de les tarifes',
                    chartArea: { width: '50%' },
                    colors: ['#007bff', '#1a88ff', '#3396ff', '#4da3ff', '#66b0ff'],
                    hAxis: {
                        title: 'Total Aparcaments',
                        minValue: 0,
                        textStyle: {
                            color: 'white'
                        },
                        titleTextStyle: {
                            color: 'white'
                        },
                        minorGridlines: {
                            color: 'white'
                        }
                    },
                    vAxis: {
                        title: 'Tarifa',
                        textStyle: {
                            color: 'white'
                        },
                        titleTextStyle: {
                            color: 'white'
                        }
                    },
                    backgroundColor: '#3b4147',
                    legend: { textStyle: { color: '#b7b7b7' } },
                    titleTextStyle: {
                        color: 'white'
                    }
                };

                var chart = new google.visualization.BarChart(document.getElementById('barChart'));


                chart.draw(data, options);
            }
        }

        function donutChart(info) {
            var datos = convertirDadesPerChart(info, ["Tipus", "Zona"]);

            google.charts.load("current", { packages: ["corechart"] });
            google.charts.setOnLoadCallback(drawChart);

            function drawChart() {
                var data = google.visualization.arrayToDataTable(datos);

                var options = {
                    title: 'Tipus de zones',
                    pieHole: 0.4,
                    colors: ['#007bff', '#28a745'],
                    backgroundColor: '#3b4147',
                    pieSliceBorderColor: '#343a40',
                    pieSliceTextStyle: {
                        color: 'white'
                    },
                    legend: { textStyle: { color: '#b7b7b7' } },
                    titleTextStyle: {
                        color: 'white'
                    }
                };

                var chart = new google.visualization.PieChart(document.getElementById('donutchart'));
                chart.draw(data, options);
                $("text:contains(Tipus de zones)").attr({ 'x': '110', 'y': '20' })
            }

        }

        function afegirPosicioposicioUsuari(map) {
            L.marker([posicioUsuari['latitude'], posicioUsuari['longitude']]).addTo(map).bindPopup('<h2>Localització actual</h2><ul><li>Latitud: '+posicioUsuari['latitude']+'</li><li>Longitud: '+posicioUsuari['longitude']+'</li></ul>');
        }

        function map(data) {
            $("#mapid").remove();
            document.getElementById('mapContainer').innerHTML =
                "<div id='mapid' style='width: 100%; height: 72.5%; float: left;'></div>";

            var mymap = L.map('mapid').setView([41.3908901, 2.1709899], 13);
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: 'pk.eyJ1Ijoic3lsb2lkIiwiYSI6ImNqdDh5Zm14bzAzMXU0M3F0Z3YxOTc5dnEifQ.dENVumuAU-SgCnUDsaqeKQ'
            }).addTo(mymap);

            

            for (i = 0; i < data.length; i++) {
                var localitzacioAparcament = data[i].geometry.coordinates[0][0];
                var localitzacioAparcament2 = data[i].geometry.coordinates[0][1];
                var zona = data[i].properties.TIPO;
                var default_color = '#007bff'; //per defecte la zona es blava
                if (zona !== 'BLAVA') {
                    default_color = "#28a745"; //si la zona es verda, canvio el color a verd
                }
                var polygon = L.polyline([
                    [localitzacioAparcament[1], localitzacioAparcament[0]],
                    [localitzacioAparcament2[1], localitzacioAparcament2[0]]
                ], {
                        color: default_color
                    }).addTo(mymap);

                polygon.bindPopup(generarContingutPopup(data[i].properties));
            }
            if(posicioUsuari !=='undefined') {afegirPosicioposicioUsuari(mymap);}
            $('.leaflet-control-zoom').append('<a class="" href="#" title="Ultima actualització: ' + lastUpdateTime + '" role="button" aria-label="" style="outline: none;"><i class="fas fa-clock" style="margin: 8.7px;"></i></a>');
        }

        function generarContingutPopup(propietats) {
            var content = document.createElement('div');
            var titol = document.createElement('h5');
            $(titol).text(propietats.TRAMO);
            $(content).append(titol);
            var id = document.createElement('p');
            $(id).html('<strong>ID:</strong> ' + propietats.ID_TRAMO);
            $(content).append(id);
            var horari = document.createElement('p');
            $(horari).html('<strong>HORARI: </strong>' + (propietats.HORARIO.replace('de ', ''))); //no vull que surti: "de Lunes a Viernes", queda lleig
            $(content).append(horari);
            var tipo = document.createElement('p');
            var zona = propietats.TIPO !== "BLAVA" ? "<span style='background-color:#369b43; color: white;'>VERDA</span>" : "<span style='background-color: #007bff; color: white'>BLAVA</span>";
            $(tipo).html('<strong>TIPUS: </strong>' + zona);
            $(content).append(tipo);
            var tarifa = document.createElement('p');
            $(tarifa).html('<strong>TARIFA: </strong>' + (propietats.TARIFA.replace('E', '<i class="fas fa-euro-sign"></i>'))); //vull que surti el simbol de euro en compte de E
            $(content).append(tarifa);
            var button = document.createElement('button');
            $(button).html('Veure predicicons');
            $(button).attr("class", "btn btn-secondary");
            $(button).attr("id", "");

            $(button).click(function () {
                generarPrediccio(propietats.TRAMO, propietats.PREDICCIONES, propietats.TIPO);
                $(window).scrollTop(0);
            });
            $(content).append(button);

            return content;
        }
        function generarPrediccio(titol, prediccions, tipus) {
            bootbox.alert({
                size: "big",
                title: titol,
                message: desglosarPreddiccio(prediccions)
            });

            if (tipus == 'BLAVA') {
                $(".modal-header").css('border-bottom', '2px solid #168cff');
            } else {
                $(".modal-header").css('border-bottom', '2px solid #28a745');
            }


            var botons = generarBotons();

            var llegenda = "<div><ul class='llegenda'><li><strong>(80%) </strong>Hi ha gran disponibilitat de places lliures</li><li><strong>(30% - 80%) </strong>Disponibilitat mitja de places lliures</li><li><strong>(0% - 10%) </strong>No hi ha disponibilitat de places lliures o es pràcticament nula</li><li>No es coneix la predicció (Zones VERDA)</li></ul></div>"
            $(".modal-footer").prepend(botons);
            $(".modal-footer").prepend(llegenda);

            date = new Date(parseInt(lastUpdateTime.substring(6, 10)), parseInt(lastUpdateTime.substring(3, 5)) - 1, parseInt(lastUpdateTime.substring(0, 2)), 8, 0, 0); //resetejem
        }

        function generarBotons() {
            var div = document.createElement('div');
            var buttonNext = document.createElement('a');
            var date2 = sumarDia(date, 1);

            $(buttonNext).addClass('btn btn-secondary');
            $(buttonNext).attr('href', '');
            $(buttonNext).text("Previsió " + date2.toString().substring(0, date.toString().indexOf("08:00:00")));
            $(buttonNext).click(function (e) {
                e.preventDefault();
                $("#taula1").css('display', 'none');
                $("#taula2").css('display', 'table');
            });

            var buttonPrev = document.createElement('a');

            $(buttonPrev).text("Previsió " + date.toString().substring(0, date.toString().indexOf("08:00:00")));
            $(buttonPrev).addClass('btn btn-secondary');
            $(buttonPrev).attr('href', '');
            $(buttonPrev).click(function (e) {
                e.preventDefault();
                $("#taula2").css('display', 'none');
                $("#taula1").css('display', 'table');
            });
            $(div).addClass('botons')
            $(div).append(buttonPrev);
            $(div).append(buttonNext);

            return div;
        }


        function sumarDia(date, dia) {
            var resultat = new Date(date);
            resultat.setDate(resultat.getDate() + dia);
            return resultat;
        }

        function desglosarPreddiccio(prediccio) {
            var taula1 = generarTaulaPrediccions(1, date, prediccio.slice(0, prediccio.length / 2));
            date.setHours(8);
            date.setMinutes(0);

            var date2 = sumarDia(date, 1);
            var taula2 = generarTaulaPrediccions(2, date2, prediccio.slice(prediccio.length / 2));
            date2.setHours(8);
            date2.setMinutes(0);

            var contenedor = document.createElement('div');
            $(contenedor).append(taula1);
            $(contenedor).append(taula2);

            return contenedor;
        }
        function formatejarTemps(date) {
            if (date < 10) {
                return "0" + date;
            }
            return date;
        }

        function limpiarPrediccions(prediccio, date) {
            var prediccioLimpia = [];
            var i;
            for (i = 0; i < prediccio.length; i++) {
                var hores = formatejarTemps(date.getHours());
                var minuts = formatejarTemps(date.getMinutes());
                var horaPrediccio = hores + ":" + minuts;

                prediccioLimpia[horaPrediccio] = prediccio.charAt(i);
                date.setMinutes(date.getMinutes() + 5);
            }

            return prediccioLimpia;
        }

        function generarTaulaPrediccions(numTaula, date, prediccio) {
            var prediccionsLimpies = limpiarPrediccions(prediccio, date);
            console.log(prediccionsLimpies)
            var div = document.createElement('div');
            $(div).load("table.html", null, function () {
                $(this).find("table").attr("id", "taula" + numTaula);
                numTaula == 2 ? $(this).find("table").css('display', 'none') : null;

                var tbody = $(this).find("table").find('tbody');


                $(tbody).find('td').each(function (j) {
                    if ($(this).attr("rowspan") == undefined) {
                        var className = $(this).attr("class");
                        var horaPrediccio = className.substring(0, 2) + ":" + className.substring(3, 5);

                        $(this).css('background-color', formatejarPrediccio(prediccionsLimpies[horaPrediccio]));
                        date.setMinutes(date.getMinutes() + 5);
                    }
                });
            });
            return div;
        }

        function formatejarPrediccio(numero) {
            if (numero == 0) {
                return "rgb(101, 107, 113)"; //gris
            } else if (numero == 1) {
                return "#28a745"; //verd
            } else if (numero == 2) {
                return "#e49420"; //taronja
            } else {
                return "#dc3545"; //vermell
            }
        }
    </script>
</body>

</html>